######################
# Environment
######################
export CCACHE=$(which ccache)
export PATH="/usr/lib/ccache:$PATH"

export FZF_TMUX=1
if command -v fd &>/dev/null || command -v fdfind &>/dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type file'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
fi

######################
# Alias
######################
# So you can quickly print a column by piping through one of the awkN-s
alias -- awk1='awk "{ print \$1 }"'
alias -- awk2='awk "{ print \$2 }"'
alias -- awk3='awk "{ print \$3 }"'
alias -- awk4='awk "{ print \$4 }"'
alias -- awk5='awk "{ print \$5 }"'

# Single letter aliases better be commonly used
alias -- c='builtin cd ..'
alias -- x='exit'
alias -- t='tmux attach -d -t'

alias -- sz='source ~/.zshrc'
alias -- jp='cd $ROOT'
alias -- more='less'
alias -- l.='ls -d .* -l --color=tty'
alias -- ll='ls -l --color=tty'
alias -- ls='ls --color=tty'
alias -- dev='source ~/dev/bin/activate'

if command -v bat &>/dev/null; then
    alias -- cat='bat'
fi

######################
# Applications
######################
dsf () { diff -u "$@" | ~/.diff-so-fancy/diff-so-fancy | less; }

######################
# Git
######################
# The choice of using an alias is to avoid having to type 'git' all the time
alias -- gs='git status'
alias -- gl='git lg'
alias -- gla='git lga'

# Fallback for git_main_branch if oh-my-zsh plugin not loaded
if ! type git_main_branch &>/dev/null; then
    git_main_branch() {
        git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@'
    }
fi

# Useful for pre-merge:
# fetches and rebases the current branch on main, and removes [run_(ci|perf)] tags
alias -- grbom='git fetch $(git_main_branch):$(git_main_branch) && git rebase origin/$(git_main_branch) && git submodule sync && git su'

# Refresh dotfiles with remote
alias -- dotfiles='cd ~/dotfiles && git stash && git pull && git stash pop'

######################
# VSCode
######################

if [[ "$TERM_PROGRAM" == "vscode" || "$TERM_PROGRAM" == "tmux" ]]; then
    export EDITOR='code --wait'
    export VISUAL=$EDITOR
    export GIT_EDITOR=$EDITOR
    export EDITOR_NB='code'
    if [[ ! $OSTYPE == 'darwin'* ]]; then
        preexec() {
            # https://github.com/microsoft/vscode-remote-release/issues/2763#issuecomment-1298256900
            socket=$(ls -1t /run/user/$UID/vscode-ipc-*.sock 2> /dev/null | head -1)
            export VSCODE_IPC_HOOK_CLI=${socket}
        }
    fi
fi
